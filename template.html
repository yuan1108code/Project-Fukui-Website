<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">äººæµæƒ…å ±ã¨è¦³å…‰åæ‰€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f7f7f7;
      font-size: 1rem;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 2vh;
      font-size: calc(2rem + 0.5vw);
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    canvas {
      display: block;
      margin: 0 auto;
      width: 100%;
      max-width: 100%;
      height: auto;
      min-height: 300px;
      max-height: 500px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* æ•´åˆå¾Œåªä¿ç•™ä¸€å€‹å€å¡Šï¼Œé¡¯ç¤ºæ’ååˆ—è¡¨ */
    .attractions {
      margin-top: 5vh;
      padding: 2vh;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2vh;
      font-size: calc(14px + 0.3vw);
    }

    th, td {
      padding: 1.5vh;
      text-align: center;
      border: 1px solid #ddd;
    }

    th {
      background-color: #f4f4f4;
      font-size: calc(16px + 0.3vw);
    }

    td img {
      vertical-align: middle;
      width: auto;
      height: 5vh;
      margin-right: 0.5em;
    }

    a {
      display: block;
      text-align: center;
      margin-top: 2vh;
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* è®“é¸ä¸­æœˆä»½çš„é …ç›®æœ‰å‹•ç•«æ•ˆæœ */
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    .flashing {
      animation: flash 0.8s ease-in-out 2;
    }
    
    /* é€™è£¡ä»ä¿ç•™é€šç”¨çš„ header-icon æ¨£å¼ */
    .header-icon {
      vertical-align: middle;
      margin-right: 8px;
    }

    /* åˆ†åˆ¥è¨­å®šå„è‡ª icon çš„å¤§å° */
    .google-icon {
      height: 24px; /* Google Trend çš„ icon å¤§å° */
    }

    .github-icon {
      height: 55px; /* Github çš„ icon å¤§å° */
    }
  </style>
</head>
<body>
  <div class="content">
    <h1 id="cityTitle"></h1>
    <canvas id="trafficChart"></canvas>

    <!-- æ•´åˆå¾Œçš„æ’åè¡¨æ ¼ -->
    <div class="attractions">
      <h2 id="trendTitle">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <table>
        <thead>
          <tr>
            <th>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</th>
            <th>
              <img class="header-icon google-icon" src="./data/Google-Trend-Logo.png" alt="Google Trend Logo">
              <!-- Google Trend -->
            </th>
            <th>
              <img class="header-icon github-icon" src="./data/GitHub-Logo.png" alt="GitHub Logo">
              <!-- Github -->
            </th>
          </tr>
        </thead>
        <tbody id="trendTable">
          <tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let selectedMonth = null;
    let trafficChart = null;
    let lastSelectedMonth = null;
    let anomalies = [];

    function getCityFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("city") || "ç¦äº•å¸‚";
    }

    function getFontSize(scale = 1) {
      return Math.max(12, window.innerWidth * 0.02 * scale);
    }

    const city = getCityFromURL();
    document.getElementById("cityTitle").textContent = city + " ã®äººæµæƒ…å ±";
    document.title = city + " ã®äººæµæƒ…å ±ã¨è¦³å…‰åæ‰€";

    document.addEventListener("DOMContentLoaded", function () {
      fetch('./data/city_traffic.json')
        .then(response => response.json())
        .then(data => {
          if (!data[city]) {
            console.error(`âŒ æ‰¾ä¸åˆ° ${city} çš„æ•¸æ“š`);
            return;
          }

          const cityData = data[city];
          const months = cityData.month;
          const counts = cityData.count;
          anomalies = cityData.anomaly; // å„²å­˜ anomalies çµ¦ highlightSelectedMonth() ä½¿ç”¨

          const ctx = document.getElementById('trafficChart').getContext('2d');

          function createChart() {
            return new Chart(ctx, {
              type: 'line',
              data: {
                labels: months,
                datasets: [{
                  label: 'äººæµæ•¸',
                  data: counts,
                  borderColor: 'rgba(54, 162, 235, 1)',
                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                  fill: true,
                  borderWidth: 2,
                  tension: 0.4,
                  pointBackgroundColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                  pointBorderColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                  pointRadius: anomalies.map(a => a === -1 ? 6 : 3),
                  pointHoverRadius: anomalies.map(a => a === -1 ? 8 : 5)
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: city + ' äººæµæ•¸è¶¨å‹¢åœ–',
                    font: { size: getFontSize(1.2) }
                  },
                  tooltip: {
                    titleFont: { size: getFontSize(0.5) },
                    bodyFont: { size: getFontSize(0.5) }
                  }
                },
                scales: {
                  x: {
                    title: {
                      display: true,
                      text: 'æœˆä»½',
                      font: { size: getFontSize(0.6) }
                    },
                    ticks: {
                      font: { size: getFontSize(0.5) }
                    }
                  },
                  y: {
                    title: {
                      display: true,
                      text: 'äººæµæ•¸',
                      font: { size: getFontSize(0.6) }
                    },
                    ticks: {
                      font: { size: getFontSize(0.5) }
                    }
                  }
                },
                onClick: (event, activeElements) => {
                  if (activeElements.length > 0) {
                    const index = activeElements[0].index;
                    let clickedMonth = trafficChart.data.labels[index].replace(/ğŸ”´ /g, ""); 
                    
                    console.log("ğŸŸ¢ é¸ä¸­çš„æœˆä»½:", clickedMonth);
                    
                    // æ›´æ–°æ•´åˆæ’åè¡¨æ ¼ï¼ˆåŒæ™‚æ›´æ–° Google Trend èˆ‡ Githubï¼‰
                    updateTrendRanking(clickedMonth);
    
                    // æ¨™è¨˜é»æ“Šçš„æœˆä»½
                    highlightSelectedMonth(clickedMonth);
                  }
                }
              }
            });
          }

          trafficChart = createChart();
        })
        .catch(err => console.error("æ•¸æ“šåŠ è¼‰å¤±æ•—: ", err));
        
      function adjustTableFontSize() {
        document.querySelector("h2#trendTitle").style.fontSize = getFontSize(0.7) + "px";
        document.querySelectorAll("th").forEach(th => th.style.fontSize = getFontSize(0.7) + "px");
        document.querySelectorAll("td").forEach(td => td.style.fontSize = getFontSize(0.6) + "px");
      }

      adjustTableFontSize();
      window.addEventListener("resize", function () {
        trafficChart.options.plugins.title.font.size = getFontSize(0.8);
        trafficChart.options.scales.x.title.font.size = getFontSize(0.6);
        trafficChart.options.scales.x.ticks.font.size = getFontSize(0.6);
        trafficChart.options.scales.y.title.font.size = getFontSize(0.8);
        trafficChart.options.scales.y.ticks.font.size = getFontSize(0.6);
        trafficChart.update();
    
        adjustTableFontSize();
      });
    
      function highlightSelectedMonth(selectedMonth) {
        if (!trafficChart) {
          console.error("âŒ `trafficChart` å°šæœªåˆå§‹åŒ–");
          return;
        }
        const chartElements = trafficChart.getDatasetMeta(0).data;
    
        // æ¸…é™¤æ‰€æœ‰ `ğŸ”´` æ¨™è¨˜
        trafficChart.data.labels = trafficChart.data.labels.map(label => label.replace(/ğŸ”´ /g, ""));
        
        let selectedIndex = -1;
        
        chartElements.forEach((element, index) => {
          let originalLabel = trafficChart.data.labels[index];
    
          if (originalLabel === selectedMonth) {
            // æ¨™ç¤ºé¸ä¸­çš„æœˆä»½
            trafficChart.data.labels[index] = `ğŸ”´ ${selectedMonth}`;
            element.options.backgroundColor = "rgba(255, 99, 132, 0.7)";
            element.options.borderColor = "red";
            element.options.radius = 8;
            element.options.hoverRadius = 10;
            selectedIndex = index;
          } else {
            element.options.backgroundColor = anomalies[index] === -1 ? "red" : "rgba(54, 162, 235, 0.2)";
            element.options.borderColor = anomalies[index] === -1 ? "red" : "blue";
            element.options.radius = anomalies[index] === -1 ? 6 : 3;
            element.options.hoverRadius = anomalies[index] === -1 ? 8 : 5;
          }
        });
    
        trafficChart.options.plugins.tooltip.callbacks.label = function (tooltipItem) {
          if (tooltipItem.dataIndex === selectedIndex) {
            return `âœ… é¸æŠæ¸ˆã¿: ${tooltipItem.raw} äºº`;
          }
          return `äººæµæ•°: ${tooltipItem.raw}`;
        };
    
        trafficChart.update();
      }
    
      // æ›´æ–°æ•´åˆå¾Œçš„ updateTrendRanking()ï¼ŒåŒæ™‚ä»¥ Google Trend çš„æ•¸æ“šæš«ä»£ Github
      function updateTrendRanking(yearMonth) {
        if (lastSelectedMonth === yearMonth) return;
        lastSelectedMonth = yearMonth;
    
        Promise.all([
          fetch('./data/city_Google_Trends.json').then(response => response.json()),
          fetch('./data/city_GitHub.json').then(response => response.json())
        ])
        .then(([googleData, githubData]) => {
          console.log("ğŸ” Google Trends è³‡æ–™:", googleData);
          console.log("ğŸ” Github è³‡æ–™:", githubData);
    
          if (!googleData[yearMonth]) {
            console.warn(`âš ï¸ æ²’æœ‰æ‰¾åˆ° ${yearMonth} çš„ Google Trend æ•¸æ“š`);
          }
          if (!githubData[yearMonth]) {
            console.warn(`âš ï¸ æ²’æœ‰æ‰¾åˆ° ${yearMonth} çš„ Github æ•¸æ“š`);
          }
    
          // ä¾ç…§ JSON æ ¼å¼ï¼ˆå‡è¨­çµæ§‹èˆ‡ Google Trend ç›¸åŒï¼‰
          const googleTrends = (googleData[yearMonth] && googleData[yearMonth][city]) || [];
          const githubRanking = (githubData[yearMonth] && githubData[yearMonth][city]) || [];
          
          // ç•¶å‰æœˆä»½äººæµæ•¸ï¼ˆä¾èˆŠå¾ chart ä¸Šå–å‡ºï¼‰
          let index = trafficChart.data.labels.findIndex(label => label.includes(yearMonth));
          let selectedCount = index !== -1 ? trafficChart.data.datasets[0].data[index] : "??";
    
          // æ›´æ–°æ¨™é¡Œï¼Œé¡¯ç¤ºæ‰€é¸æœˆä»½åŠäººæµæ•¸
          document.getElementById("trendTitle").innerHTML = 
            `ãƒ©ãƒ³ã‚­ãƒ³ã‚° (${yearMonth}) - äººæµæ•° ${selectedCount} äºº`;
    
          // ç”¢ç”Ÿæ’åè¡¨æ ¼å…§å®¹ï¼Œå›ºå®š Top 1 è‡³ Top 5
          let html = "";
          for (let i = 0; i < 5; i++) {
            // è‹¥æœ‰å°æ‡‰è³‡æ–™å‰‡é¡¯ç¤ºåå­—ï¼Œå¦å‰‡é¡¯ç¤ºã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€
            const googleItem = googleTrends[i] ? googleTrends[i].name : "ãƒ‡ãƒ¼ã‚¿ãªã—";
            const githubItem = githubRanking[i] ? githubRanking[i].name : "ãƒ‡ãƒ¼ã‚¿ãªã—";
    
            html += `
              <tr class="flashing">
                <td>Top${i+1}</td>
                <td>${googleItem}</td>
                <td>${githubItem}</td>
              </tr>
            `;
          }
    
          document.getElementById("trendTable").innerHTML = html;
          highlightSelectedMonth(yearMonth);
        })
        .catch(err => console.error("âŒ è¼‰å…¥æ’åæ•¸æ“šå¤±æ•—: ", err));
      }
    
    });
  </script>

  <a href="./index.html">æˆ»ã‚‹</a>
</body>
</html>