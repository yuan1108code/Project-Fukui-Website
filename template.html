<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">äººæµæƒ…å ±ã¨è¦³å…‰åæ‰€</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f7f7f7;
      font-size: 1rem;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 2vh;
      font-size: calc(2rem + 0.5vw);
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    canvas {
      display: block;
      margin: 0 auto;
      width: 100%;
      max-width: 100%;
      height: auto;
      min-height: 300px;
      max-height: 500px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* æ•´åˆå¾Œåªä¿ç•™ä¸€å€‹å€å¡Šï¼Œé¡¯ç¤ºæ’ååˆ—è¡¨ */
    .attractions {
      margin-top: 5vh;
      padding: 2vh;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    /* åœ–è¡¨æ¨™ç±¤å­—é«”ç¸®å°æ¨£å¼ */
    .chart-label-smaller {
      font-size: 0.7em !important;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2vh;
      font-size: calc(14px + 0.3vw);
    }

    th, td {
      padding: 1.5vh;
      text-align: center;
      border: 1px solid #ddd;
    }

    th {
      background-color: #f4f4f4;
      font-size: calc(16px + 0.3vw);
    }

    td img {
      vertical-align: middle;
      width: auto;
      height: 5vh;
      margin-right: 0.5em;
    }

    a {
      display: block;
      text-align: center;
      margin-top: 2vh;
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* è®“é¸ä¸­æœˆä»½çš„é …ç›®æœ‰å‹•ç•«æ•ˆæœ */
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    .flashing {
      animation: flash 0.8s ease-in-out 2;
    }
    
    /* é€™è£¡ä»ä¿ç•™é€šç”¨çš„ header-icon æ¨£å¼ */
    .header-icon {
      vertical-align: middle;
      margin-right: 8px;
    }

    /* åˆ†åˆ¥è¨­å®šå„è‡ª icon çš„å¤§å° */
    .google-icon {
      height: 24px; /* Google Trend çš„ icon å¤§å° */
    }

    .github-icon {
      height: 55px; /* Github çš„ icon å¤§å° */
    }

    .weather-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
      white-space: nowrap;
      position: relative;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      border: 1px solid #eee;
    }
  
    .weather-label {
      font-size: 1.0em;
      color: #666;
      margin-right: 4px;
    }
  
    .weather-unit {
      font-size: 1.0em;
      color: #888;
      margin-left: 4px;
    }

    .weather-item img {
      vertical-align: middle;
    }

    .weather-info {
      font-size: 0.8em;
      color: #666;
      background: rgba(255, 255, 255, 0.8);
      padding: 8px;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      .weather-info {
        flex-direction: column;
        gap: 5px;
      }
      
      .weather-item {
        width: 100%;
        justify-content: space-between;
      }
  
      #trendTitle {
        flex-direction: column;
        gap: 10px;
      }
  
      .weather-unit {
        display: block;
        width: 100%;
        text-align: center;
        margin-top: 2px;
      }
    }
  </style>
</head>
<body>
  <div class="content">
    <h1 id="cityTitle"></h1>
    
    <canvas id="trafficChart"></canvas>



    <!-- æ•´åˆå¾Œçš„æ’åè¡¨æ ¼ -->
    <div class="attractions">
      <h2 id="trendTitle" style="display: flex; justify-content: space-between; align-items: center;">
        <span class="ranking-info">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
        <span class="weather-info" style="display: flex; align-items: center; gap: 15px;">
          <span class="weather-item">
            <span class="weather-label">æ°—æ¸©</span>
              <img src="./data/Temperature.png" alt="Temperature" style="height: 24px;">
              <span id="tempInfo">--</span>
              <span class="weather-unit">(æœ€ä½/å¹³å‡/æœ€é«˜)</span>
            </span>
            <span class="weather-item">
              <span class="weather-label">é™æ°´é‡</span>
              <img src="./data/Rain.png" alt="Rain" style="height: 24px;">
              <span id="rainInfo">--</span>
            </span>
            <span class="weather-item">
              <span class="weather-label">æ—¥ç…§æ™‚é–“</span>
              <img src="./data/Sun.png" alt="Sun" style="height: 24px;">
              <span id="sunInfo">--</span>
            </span>
          </span>
        </span>
      </h2>
      <table>
        <thead>
          <tr>
            <th>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</th>
            <th>
              <img class="header-icon google-icon" src="./data/Google-Trend-Logo.png" alt="Google Trend Logo">
              <!-- Google Trend -->
            </th>
            <th>
              <img class="header-icon github-icon" src="./data/GitHub-Logo.png" alt="GitHub Logo">
              <!-- Github -->
            </th>
          </tr>
        </thead>
        <tbody id="trendTable">
          <tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
        </tbody>
      </table>
    </div>
  
    <!-- æ–°å¢åœ°åœ–å€å¡Š -->
    <div id="mapContainer" style="margin-top: 3vh; margin-bottom: 3vh;">
      <h2 style="text-align: center;">è¦³å…‰ã‚¹ãƒãƒƒãƒˆåœ°å›³</h2>
      <div id="map" style="width: 100%; height: 50vh; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);"></div>
    </div>
  </div>

  <script>
    let selectedMonth = null;
    let trafficChart = null;
    let lastSelectedMonth = null;
    let anomalies = [];
    let map = null;
    let markers = [];
    let locationData = [];
    let hotLocations = new Set(); // å­˜å„²ç†±é–€æ™¯é»ï¼ˆå‡ºç¾åœ¨æ’åä¸­çš„æ™¯é»ï¼‰
    let weatherData = {}; // å­˜å„²å¤©æ°£æ•¸æ“š

    function getCityFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("city") || "ç¦äº•å¸‚";
    }

    function getFontSize(scale = 1) {
      return Math.max(12, window.innerWidth * 0.02 * scale);
    }

    const city = getCityFromURL();
    document.getElementById("cityTitle").textContent = city + " ã®äººæµæƒ…å ±";
    document.title = city + " ã®äººæµæƒ…å ±ã¨è¦³å…‰åæ‰€";

    document.addEventListener("DOMContentLoaded", function () {
      // å…ˆåŠ è¼‰å¤©æ°£æ•¸æ“š
      fetch('./data/weather_data.json')
        .then(response => response.json())
        .then(data => {
          if (data[city]) {
            weatherData = data[city];
            console.log("âœ… å·²è¼‰å…¥å¤©æ°£æ•¸æ“š:", city, weatherData);
            
            // åœ¨å¤©æ°£æ•¸æ“šåŠ è¼‰å®Œæˆå¾Œå†åŠ è¼‰äº¤é€šæ•¸æ“šå’Œå‰µå»ºåœ–è¡¨
            loadTrafficDataAndCreateChart();
          } else {
            console.error(`âŒ æ‰¾ä¸åˆ° ${city} çš„å¤©æ°£æ•¸æ“š`);
            // å³ä½¿æ²’æœ‰å¤©æ°£æ•¸æ“šï¼Œä¹Ÿç¹¼çºŒåŠ è¼‰äº¤é€šæ•¸æ“š
            loadTrafficDataAndCreateChart();
          }
        })
        .catch(err => {
          console.error("è¼‰å…¥å¤©æ°£æ•¸æ“šå¤±æ•—: ", err);
          // å‡ºéŒ¯æ™‚ä¹Ÿç¹¼çºŒåŠ è¼‰äº¤é€šæ•¸æ“š
          loadTrafficDataAndCreateChart();
        });
        
      // è¼‰å…¥æ™¯é»è³‡æ–™ï¼ˆå¯ä»¥èˆ‡å¤©æ°£æ•¸æ“šä¸¦è¡ŒåŠ è¼‰ï¼‰
      fetch('./data/fukui_location.json')
        .then(response => response.json())
        .then(data => {
          locationData = data.filter(location => location.city === city);
          initMap();
        })
        .catch(err => console.error("è¼‰å…¥æ™¯é»è³‡æ–™å¤±æ•—: ", err));
        
      // å°‡äº¤é€šæ•¸æ“šåŠ è¼‰å’Œåœ–è¡¨å‰µå»ºç§»åˆ°å–®ç¨çš„å‡½æ•¸ä¸­
      function loadTrafficDataAndCreateChart() {
        fetch('./data/city_traffic.json')
          .then(response => response.json())
          .then(data => {
            if (!data[city]) {
              console.error(`âŒ æ‰¾ä¸åˆ° ${city} çš„æ•¸æ“š`);
              return;
            }

          const cityData = data[city];
          const months = cityData.month;
          const counts = cityData.count;
          anomalies = cityData.anomaly; // å„²å­˜ anomalies çµ¦ highlightSelectedMonth() ä½¿ç”¨

          const ctx = document.getElementById('trafficChart').getContext('2d');

            function createChart() {
              // ç²å–å¤©æ°£æ•¸æ“šä¸¦è¼¸å‡ºåˆ°æ§åˆ¶å°é€²è¡Œèª¿è©¦
              const tempData = getWeatherDataForMonths(months, 'average_temp');
              const minTempData = getWeatherDataForMonths(months, 'min_temp');
              const maxTempData = getWeatherDataForMonths(months, 'max_temp');
              const rainData = getWeatherDataForMonths(months, 'rainfall');
              const sunData = getWeatherDataForMonths(months, 'sunshine_hours');
              
              console.log("æº«åº¦æ•¸æ“š:", tempData);
              console.log("æœ€ä½æº«åº¦æ•¸æ“š:", minTempData);
              console.log("æœ€é«˜æº«åº¦æ•¸æ“š:", maxTempData);
              console.log("é™æ°´é‡æ•¸æ“š:", rainData);
              console.log("æ—¥ç…§æ™‚é–“æ•¸æ“š:", sunData);
              
              return new Chart(ctx, {
                type: 'line',
                data: {
                  labels: months,
                  datasets: [{
                    label: 'äººæµæ•°',
                    data: counts,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: true,
                    borderWidth: 2,
                    tension: 0.4,
                    pointBackgroundColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                    pointBorderColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                    pointRadius: anomalies.map(a => a === -1 ? 6 : 3),
                    pointHoverRadius: anomalies.map(a => a === -1 ? 8 : 5),
                    yAxisID: 'y'
                  },
                  {
                    label: 'å¹³å‡æ°—æ¸© (Â°C)',
                    data: tempData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    hidden: true,
                    yAxisID: 'y1'
                  },
                  {
                    label: 'æœ€ä½æ°—æ¸© (Â°C)',
                    data: minTempData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    hidden: true,
                    yAxisID: 'y1'
                  },
                  {
                    label: 'æœ€é«˜æ°—æ¸© (Â°C)',
                    data: maxTempData,
                    borderColor: 'rgba(255, 159, 64, 1)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    hidden: true,
                    yAxisID: 'y1'
                  },
                  {
                    label: 'é™æ°´é‡ (mm)',
                    data: rainData,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    hidden: true,
                    yAxisID: 'y2'
                  },
                  {
                    label: 'æ—¥ç…§æ™‚é–“ (æ™‚é–“)',
                    data: sunData,
                    borderColor: 'rgba(255, 206, 86, 1)',
                    backgroundColor: 'rgba(255, 206, 86, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    hidden: true,
                    yAxisID: 'y3'
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    title: {
                      display: true,
                      text: city + ' äººæµæ•¸è¶¨å‹¢åœ–',
                      font: { size: getFontSize(1.2) }
                    },
                    tooltip: {
                      titleFont: { size: getFontSize(0.5) },
                      bodyFont: { size: getFontSize(0.5) }
                    },
                    legend: {
                      onClick: function(e, legendItem, legend) {
                        const index = legendItem.datasetIndex;
                        const ci = this.chart;
                        
                        // åˆ‡æ›æ•¸æ“šé›†å¯è¦‹æ€§
                        const meta = ci.getDatasetMeta(index);
                        meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
                        
                        // å…ˆæ›´æ–°åœ–è¡¨
                        ci.update('none'); // ä½¿ç”¨ 'none' é¿å…å‹•ç•«å»¶é²
                        
                        // ç„¶å¾Œæ›´æ–°Yè»¸é¡¯ç¤º
                        updateYAxisVisibility();
                      },
                      labels: {
                        font: { size: getFontSize(0.45) }
                      }
                    }
                  },
                  scales: {
                    x: {
                      title: {
                        display: true,
                        text: 'æœˆä»½',
                        font: { size: getFontSize(0.6) }
                      },
                      ticks: {
                        font: { size: getFontSize(0.5) }
                      }
                    },
                    y: {
                      position: 'left',
                      title: {
                        display: true,
                        text: 'äººæµæ•°',
                        font: { size: getFontSize(0.6) }
                      },
                      ticks: {
                        font: { size: getFontSize(0.5) }
                      }
                    },
                    y1: {
                      position: 'right',
                      title: {
                        display: true,
                        text: 'æ°—æ¸© (Â°C)',
                        font: { size: getFontSize(0.6) }
                      },
                      ticks: {
                        font: { size: getFontSize(0.5) }
                      },
                      grid: {
                        drawOnChartArea: false
                      },
                      display: false, // åˆå§‹éš±è—
                      min: -5,
                      max: 40
                    },
                    y2: {
                      position: 'right',
                      title: {
                        display: true,
                        text: 'é™æ°´é‡ (mm)',
                        font: { size: getFontSize(0.6) }
                      },
                      ticks: {
                        font: { size: getFontSize(0.5) }
                      },
                      grid: {
                        drawOnChartArea: false
                      },
                      display: false, // åˆå§‹éš±è—
                      min: 0,
                      max: 500
                    },
                    y3: {
                      position: 'right',
                      title: {
                        display: true,
                        text: 'æ—¥ç…§æ™‚é–“ (æ™‚é–“)',
                        font: { size: getFontSize(0.6) }
                      },
                      ticks: {
                        font: { size: getFontSize(0.5) }
                      },
                      grid: {
                        drawOnChartArea: false
                      },
                      display: false, // åˆå§‹éš±è—
                      min: 0,
                      max: 300
                    }
                  },
                  onClick: (event, activeElements) => {
                    if (activeElements.length > 0) {
                      const index = activeElements[0].index;
                      let clickedMonth = trafficChart.data.labels[index].replace(/ğŸ”´ /g, ""); 
                      
                      console.log("ğŸŸ¢ é¸ä¸­çš„æœˆä»½:", clickedMonth);
                      
                      // æ›´æ–°æ•´åˆæ’åè¡¨æ ¼ï¼ˆåŒæ™‚æ›´æ–° Google Trend èˆ‡ Githubï¼‰
                      updateTrendRanking(clickedMonth);
      
                      // æ¨™è¨˜é»æ“Šçš„æœˆä»½
                      highlightSelectedMonth(clickedMonth);
                    }
                  }
                }
              });
            }

            trafficChart = createChart();
            
            // åœ¨åœ–è¡¨å‰µå»ºå¾Œç¢ºä¿åˆå§‹ç‹€æ…‹æ­£ç¢º
            updateYAxisVisibility(); // ç¢ºä¿åˆå§‹ç‹€æ…‹ä¸‹åªé¡¯ç¤ºéœ€è¦çš„è»¸
            trafficChart.update();
          })
          .catch(err => console.error("æ•¸æ“šåŠ è¼‰å¤±æ•—: ", err));
      }

      function adjustTableFontSize() {
        document.querySelector("h2#trendTitle").style.fontSize = getFontSize(0.7) + "px";
        document.querySelectorAll("th").forEach(th => th.style.fontSize = getFontSize(0.7) + "px");
        document.querySelectorAll("td").forEach(td => td.style.fontSize = getFontSize(0.6) + "px");
      }

      adjustTableFontSize();
      window.addEventListener("resize", function () {
        trafficChart.options.plugins.title.font.size = getFontSize(0.8);
        trafficChart.options.scales.x.title.font.size = getFontSize(0.6);
        trafficChart.options.scales.x.ticks.font.size = getFontSize(0.6);
        trafficChart.options.scales.y.title.font.size = getFontSize(0.8);
        trafficChart.options.scales.y.ticks.font.size = getFontSize(0.6);
        trafficChart.update();
        adjustTableFontSize();
      });
    
      function highlightSelectedMonth(selectedMonth) {
        if (!trafficChart) {
          console.error("âŒ `trafficChart` å°šæœªåˆå§‹åŒ–");
          return;
        }
        const chartElements = trafficChart.getDatasetMeta(0).data;
    
        // æ¸…é™¤æ‰€æœ‰ `ğŸ”´` æ¨™è¨˜
        trafficChart.data.labels = trafficChart.data.labels.map(label => label.replace(/ğŸ”´ /g, ""));
        
        let selectedIndex = -1;
        
        chartElements.forEach((element, index) => {
          let originalLabel = trafficChart.data.labels[index];
    
          if (originalLabel === selectedMonth) {
            // æ¨™ç¤ºé¸ä¸­çš„æœˆä»½
            trafficChart.data.labels[index] = `ğŸ”´ ${selectedMonth}`;
            element.options.backgroundColor = "rgba(255, 99, 132, 0.7)";
            element.options.borderColor = "red";
            element.options.radius = 8;
            element.options.hoverRadius = 10;
            selectedIndex = index;
          } else {
            element.options.backgroundColor = anomalies[index] === -1 ? "red" : "rgba(54, 162, 235, 0.2)";
            element.options.borderColor = anomalies[index] === -1 ? "red" : "blue";
            element.options.radius = anomalies[index] === -1 ? 6 : 3;
            element.options.hoverRadius = anomalies[index] === -1 ? 8 : 5;
          }
        });
    
        trafficChart.options.plugins.tooltip.callbacks.label = function (tooltipItem) {
          if (tooltipItem.dataIndex === selectedIndex) {
            return `âœ… é¸æŠæ¸ˆã¿: ${tooltipItem.raw} äºº`;
          }
          return `äººæµæ•°: ${tooltipItem.raw}`;
        };
    
        trafficChart.update();
      }
    
      // åˆå§‹åŒ–åœ°åœ–
      function initMap() {
        // å‰µå»ºåœ°åœ–
        map = L.map('map').setView([36.0641, 136.2196], 12); // é è¨­ç¦äº•å¸‚ä¸­å¿ƒä½ç½®

        // æ·»åŠ åœ°åœ–åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // å¦‚æœæœ‰è©²åŸå¸‚çš„æ™¯é»è³‡æ–™ï¼Œèª¿æ•´åœ°åœ–è¦–è§’
        if (locationData.length > 0) {
          // è¨ˆç®—æ‰€æœ‰æ™¯é»çš„å¹³å‡ç¶“ç·¯åº¦ä½œç‚ºåœ°åœ–ä¸­å¿ƒ
          const latSum = locationData.reduce((sum, loc) => sum + loc.coordinates.latitude, 0);
          const lngSum = locationData.reduce((sum, loc) => sum + loc.coordinates.longitude, 0);
          const centerLat = latSum / locationData.length;
          const centerLng = lngSum / locationData.length;
          
          map.setView([centerLat, centerLng], 11);
          
          // æ·»åŠ æ‰€æœ‰æ™¯é»æ¨™è¨˜
          updateMapMarkers();
        }
      }

      // æ›´æ–°åœ°åœ–æ¨™è¨˜
      function updateMapMarkers() {
        // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        
        // æ·»åŠ æ–°æ¨™è¨˜
        locationData.forEach(location => {
          const isHot = hotLocations.has(location.location);
          const icon = L.icon({
            iconUrl: isHot ? './data/localization_hot.png' : './data/localization.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
          });
          
          // ç²å–ç†±é–€åº¦æŒ‡æ¨™ä¿¡æ¯
          let popularityInfo = "";
          if (isHot && lastSelectedMonth) {
            // æª¢æŸ¥Googleè¶¨å‹¢æ’å
            const googleRank = getLocationRank(location.location, 'google');
            if (googleRank > 0) {
              popularityInfo += `<br>Google Trends: Top${googleRank}`;
            }
            
            // æª¢æŸ¥GitHubæ’å
            const githubRank = getLocationRank(location.location, 'github');
            if (githubRank > 0) {
              popularityInfo += `<br>GitHub: Top${githubRank}`;
            }
          }
          
          const marker = L.marker(
            [location.coordinates.latitude, location.coordinates.longitude], 
            { icon: icon }
          ).addTo(map);
          
          marker.bindPopup(`<b>${location.location}</b><br>${location.city}${popularityInfo}`);
          markers.push(marker);
        });
      }

      // ç²å–æ™¯é»åœ¨ç‰¹å®šæ•¸æ“šæºä¸­çš„æ’å
      function getLocationRank(locationName, source) {
        if (!lastSelectedMonth) return -1;
        
        // ç›´æ¥ä½¿ç”¨å·²ç¶“è¼‰å…¥çš„æ’åæ•¸æ“š
        if (source === 'google' && window.currentGoogleRanking) {
          for (let i = 0; i < window.currentGoogleRanking.length; i++) {
            if (window.currentGoogleRanking[i].name === locationName) {
              return i + 1; // æ’åå¾1é–‹å§‹
            }
          }
        } else if (source === 'github' && window.currentGithubRanking) {
          for (let i = 0; i < window.currentGithubRanking.length; i++) {
            if (window.currentGithubRanking[i].name === locationName) {
              return i + 1; // æ’åå¾1é–‹å§‹
            }
          }
        }
        
        return -1; // æœªæ‰¾åˆ°æ’å
      }

      // æ›´æ–°æ•´åˆå¾Œçš„ updateTrendRanking()
      function updateTrendRanking(yearMonth) {
        if (lastSelectedMonth === yearMonth) return;
        lastSelectedMonth = yearMonth;
    
        Promise.all([
          fetch('./data/city_Google_Trends.json').then(response => response.json()),
          fetch('./data/city_GitHub.json').then(response => response.json()),
          fetch('./data/weather_data.json').then(response => response.json())
        ])
        .then(([googleData, githubData, weatherData]) => {
          console.log("ğŸ” Google Trends è³‡æ–™:", googleData);
          console.log("ğŸ” Github è³‡æ–™:", githubData);
          console.log("ğŸ” Weather è³‡æ–™:", weatherData);

          if (!googleData[yearMonth]) {
            console.warn(`âš ï¸ æ²’æœ‰æ‰¾åˆ° ${yearMonth} çš„ Google Trend æ•¸æ“š`);
          }
          if (!githubData[yearMonth]) {
            console.warn(`âš ï¸ æ²’æœ‰æ‰¾åˆ° ${yearMonth} çš„ Github æ•¸æ“š`);
          }
    
          // ä¾ç…§ JSON æ ¼å¼ï¼ˆå‡è¨­çµæ§‹èˆ‡ Google Trend ç›¸åŒï¼‰
          const googleTrends = (googleData[yearMonth] && googleData[yearMonth][city]) || [];
          const githubRanking = (githubData[yearMonth] && githubData[yearMonth][city]) || [];
          
          // ç•¶å‰æœˆä»½äººæµæ•¸ï¼ˆä¾èˆŠå¾ chart ä¸Šå–å‡ºï¼‰
          let index = trafficChart.data.labels.findIndex(label => label.includes(yearMonth));
          let selectedCount = index !== -1 ? trafficChart.data.datasets[0].data[index] : "??";
          
          // è™•ç†å¤©æ°£è³‡æ–™
          const cityWeather = weatherData[city] && weatherData[city][yearMonth];
          if (cityWeather) {
            document.getElementById("tempInfo").innerHTML = 
              `${cityWeather.min_temp}Â°C / ${cityWeather.average_temp}Â°C / ${cityWeather.max_temp}Â°C`;
            
            const rainfall = cityWeather.rainfall === -99 ? "N/A" : `${cityWeather.rainfall}mm`;
            document.getElementById("rainInfo").innerHTML = rainfall;
            
            const sunshine = cityWeather.sunshine_hours === -99 ? "N/A" : `${cityWeather.sunshine_hours}h`;
            document.getElementById("sunInfo").innerHTML = sunshine;
          } else {
            document.getElementById("tempInfo").innerHTML = "N/A";
            document.getElementById("rainInfo").innerHTML = "N/A";
            document.getElementById("sunInfo").innerHTML = "N/A";
          }

          document.querySelector(".ranking-info").innerHTML = 
            `ãƒ©ãƒ³ã‚­ãƒ³ã‚° (${yearMonth}) - äººæµæ•° ${selectedCount} äºº`;
    
          // æ›´æ–°ç†±é–€æ™¯é»é›†åˆ
          hotLocations.clear();
          googleTrends.forEach((item, index) => {
            if (item && item.name) {
              hotLocations.add(item.name);
              // å„²å­˜Googleæ’åä¿¡æ¯
              item.rank = index + 1;
            }
          });
          
          githubRanking.forEach((item, index) => {
            if (item && item.name) {
              hotLocations.add(item.name);
              // å„²å­˜GitHubæ’åä¿¡æ¯
              item.rank = index + 1;
            }
          });
          
          // å„²å­˜æ’åæ•¸æ“šä»¥ä¾›å½ˆå‡ºçª—å£ä½¿ç”¨
          window.currentGoogleRanking = googleTrends;
          window.currentGithubRanking = githubRanking;
          
          // æ›´æ–°åœ°åœ–æ¨™è¨˜
          updateMapMarkers();
    
          // ç”¢ç”Ÿæ’åè¡¨æ ¼å…§å®¹ï¼Œå›ºå®š Top 1 è‡³ Top 5
          let html = "";
          for (let i = 0; i < 5; i++) {
            // è‹¥æœ‰å°æ‡‰è³‡æ–™å‰‡é¡¯ç¤ºåå­—ï¼Œå¦å‰‡é¡¯ç¤ºã€Œãƒ‡ãƒ¼ã‚¿ãªã—ã€
            const googleItem = googleTrends[i] ? googleTrends[i].name : "ãƒ‡ãƒ¼ã‚¿ãªã—";
            const githubItem = githubRanking[i] ? githubRanking[i].name : "ãƒ‡ãƒ¼ã‚¿ãªã—";
    
            html += `
              <tr class="flashing">
                <td>Top${i+1}</td>
                <td>${googleItem}</td>
                <td>${githubItem}</td>
              </tr>
            `;
          }
    
          document.getElementById("trendTable").innerHTML = html;
          highlightSelectedMonth(yearMonth);
        })
        .catch(err => console.error("âŒ è¼‰å…¥æ’åæ•¸æ“šå¤±æ•—: ", err));
      }
    
    });

    // æ ¹æ“šæœˆä»½ç²å–å¤©æ°£æ•¸æ“š
    function getWeatherDataForMonths(months, dataType) {
      if (!weatherData) return Array(months.length).fill(null);
      
      return months.map(month => {
        // å°‡æœˆä»½æ ¼å¼å¾ "2022å¹´1æœˆ" è½‰æ›ç‚º "2022-01"
        const formattedMonth = month.replace(/(\d{4})å¹´(\d{1,2})æœˆ/, (match, year, month) => {
          return `${year}-${month.padStart(2, '0')}`;
        });
        
        if (weatherData[formattedMonth] && weatherData[formattedMonth][dataType] !== undefined) {
          // ç¢ºä¿è¿”å›æ•¸å€¼è€Œéå­—ç¬¦ä¸²
          const value = weatherData[formattedMonth][dataType];
          return value === -99 ? null : Number(value);
        }
        return null;
      });
    }
    
    // æ›´æ–°Yè»¸çš„é¡¯ç¤ºç‹€æ…‹
    function updateYAxisVisibility() {
      if (!trafficChart) return;
    
      // æª¢æŸ¥å„æ•¸æ“šé›†çš„å¯è¦‹ç‹€æ…‹ - ä½¿ç”¨ isDatasetVisible æ–¹æ³•
      const tempVisible = 
        trafficChart.isDatasetVisible(1) || 
        trafficChart.isDatasetVisible(2) || 
        trafficChart.isDatasetVisible(3);
      
      const rainVisible = trafficChart.isDatasetVisible(4);
      const sunVisible = trafficChart.isDatasetVisible(5);
      
      console.log("åœ–ä¾‹é»æ“Šå¾Œ - æº«åº¦å¯è¦‹:", tempVisible, "é™æ°´é‡å¯è¦‹:", rainVisible, "æ—¥ç…§å¯è¦‹:", sunVisible);
      
      // ç›´æ¥è¨­ç½®è»¸çš„é¡¯ç¤ºç‹€æ…‹
      trafficChart.options.scales.y1.display = tempVisible;
      trafficChart.options.scales.y2.display = rainVisible;
      trafficChart.options.scales.y3.display = sunVisible;
      
      // é‡ç½®æ‰€æœ‰è»¸çš„åç§»è¨­ç½®
      ['y1', 'y2', 'y3'].forEach(axisId => {
        if (trafficChart.options.scales[axisId].afterFit) {
          delete trafficChart.options.scales[axisId].afterFit;
        }
      });
      
      // è¨ˆç®—éœ€è¦é¡¯ç¤ºçš„è»¸
      const visibleAxes = [];
      if (tempVisible) visibleAxes.push('y1');
      if (rainVisible) visibleAxes.push('y2');
      if (sunVisible) visibleAxes.push('y3');
      
      // å¦‚æœæœ‰å¤šå€‹è»¸éœ€è¦é¡¯ç¤ºï¼Œè¨­ç½®åç§»é‡
      if (visibleAxes.length > 1) {
        visibleAxes.forEach((axisId, index) => {
          if (index > 0) {
            // å¾ç¬¬äºŒå€‹è»¸é–‹å§‹è¨­ç½®åç§»
            trafficChart.options.scales[axisId].afterFit = function(scale) {
              scale.paddingRight = index * 40;
            };
          }
        });
      }
      
      // å¼·åˆ¶æ›´æ–°åœ–è¡¨ä»¥æ‡‰ç”¨æ–°çš„è»¸è¨­ç½®
      trafficChart.update();
      
      console.log("Yè»¸é¡¯ç¤ºç‹€æ…‹ - Y1:", trafficChart.options.scales.y1.display, 
                  "Y2:", trafficChart.options.scales.y2.display, 
                  "Y3:", trafficChart.options.scales.y3.display);
    }
    
  </script>

  <a href="./index.html">æˆ»ã‚‹</a>
</body>
</html>