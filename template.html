<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">人流情報と観光名所</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f7f7f7;
      font-size: 1rem;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 2vh;
      font-size: calc(2rem + 0.5vw);
    }

    .content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    canvas {
      display: block;
      margin: 0 auto;
      width: 100%;
      max-width: 100%;
      height: auto;
      min-height: 300px;
      max-height: 500px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* 整合後只保留一個區塊，顯示排名列表 */
    .attractions {
      margin-top: 5vh;
      padding: 2vh;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2vh;
      font-size: calc(14px + 0.3vw);
    }

    th, td {
      padding: 1.5vh;
      text-align: center;
      border: 1px solid #ddd;
    }

    th {
      background-color: #f4f4f4;
      font-size: calc(16px + 0.3vw);
    }

    td img {
      vertical-align: middle;
      width: auto;
      height: 5vh;
      margin-right: 0.5em;
    }

    a {
      display: block;
      text-align: center;
      margin-top: 2vh;
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* 讓選中月份的項目有動畫效果 */
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    .flashing {
      animation: flash 0.8s ease-in-out 2;
    }
    
    /* 這裡仍保留通用的 header-icon 樣式 */
    .header-icon {
      vertical-align: middle;
      margin-right: 8px;
    }

    /* 分別設定各自 icon 的大小 */
    .google-icon {
      height: 24px; /* Google Trend 的 icon 大小 */
    }

    .github-icon {
      height: 55px; /* Github 的 icon 大小 */
    }
  </style>
</head>
<body>
  <div class="content">
    <h1 id="cityTitle"></h1>
    <canvas id="trafficChart"></canvas>

    <!-- 整合後的排名表格 -->
    <div class="attractions">
      <h2 id="trendTitle">ランキング</h2>
      <table>
        <thead>
          <tr>
            <th>ランキング</th>
            <th>
              <img class="header-icon google-icon" src="./data/Google-Trend-Logo.png" alt="Google Trend Logo">
              <!-- Google Trend -->
            </th>
            <th>
              <img class="header-icon github-icon" src="./data/GitHub-Logo.png" alt="GitHub Logo">
              <!-- Github -->
            </th>
          </tr>
        </thead>
        <tbody id="trendTable">
          <tr><td colspan="3">データを選択してください</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let selectedMonth = null;
    let trafficChart = null;
    let lastSelectedMonth = null;
    let anomalies = [];

    function getCityFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("city") || "福井市";
    }

    function getFontSize(scale = 1) {
      return Math.max(12, window.innerWidth * 0.02 * scale);
    }

    const city = getCityFromURL();
    document.getElementById("cityTitle").textContent = city + " の人流情報";
    document.title = city + " の人流情報と観光名所";

    document.addEventListener("DOMContentLoaded", function () {
      fetch('./data/city_traffic.json')
        .then(response => response.json())
        .then(data => {
          if (!data[city]) {
            console.error(`❌ 找不到 ${city} 的數據`);
            return;
          }

          const cityData = data[city];
          const months = cityData.month;
          const counts = cityData.count;
          anomalies = cityData.anomaly; // 儲存 anomalies 給 highlightSelectedMonth() 使用

          const ctx = document.getElementById('trafficChart').getContext('2d');

          function createChart() {
            return new Chart(ctx, {
              type: 'line',
              data: {
                labels: months,
                datasets: [{
                  label: '人流數',
                  data: counts,
                  borderColor: 'rgba(54, 162, 235, 1)',
                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                  fill: true,
                  borderWidth: 2,
                  tension: 0.4,
                  pointBackgroundColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                  pointBorderColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                  pointRadius: anomalies.map(a => a === -1 ? 6 : 3),
                  pointHoverRadius: anomalies.map(a => a === -1 ? 8 : 5)
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: city + ' 人流數趨勢圖',
                    font: { size: getFontSize(1.2) }
                  },
                  tooltip: {
                    titleFont: { size: getFontSize(0.5) },
                    bodyFont: { size: getFontSize(0.5) }
                  }
                },
                scales: {
                  x: {
                    title: {
                      display: true,
                      text: '月份',
                      font: { size: getFontSize(0.6) }
                    },
                    ticks: {
                      font: { size: getFontSize(0.5) }
                    }
                  },
                  y: {
                    title: {
                      display: true,
                      text: '人流數',
                      font: { size: getFontSize(0.6) }
                    },
                    ticks: {
                      font: { size: getFontSize(0.5) }
                    }
                  }
                },
                onClick: (event, activeElements) => {
                  if (activeElements.length > 0) {
                    const index = activeElements[0].index;
                    let clickedMonth = trafficChart.data.labels[index].replace(/🔴 /g, ""); 
                    
                    console.log("🟢 選中的月份:", clickedMonth);
                    
                    // 更新整合排名表格（同時更新 Google Trend 與 Github）
                    updateTrendRanking(clickedMonth);
    
                    // 標記點擊的月份
                    highlightSelectedMonth(clickedMonth);
                  }
                }
              }
            });
          }

          trafficChart = createChart();
        })
        .catch(err => console.error("數據加載失敗: ", err));
        
      function adjustTableFontSize() {
        document.querySelector("h2#trendTitle").style.fontSize = getFontSize(0.7) + "px";
        document.querySelectorAll("th").forEach(th => th.style.fontSize = getFontSize(0.7) + "px");
        document.querySelectorAll("td").forEach(td => td.style.fontSize = getFontSize(0.6) + "px");
      }

      adjustTableFontSize();
      window.addEventListener("resize", function () {
        trafficChart.options.plugins.title.font.size = getFontSize(0.8);
        trafficChart.options.scales.x.title.font.size = getFontSize(0.6);
        trafficChart.options.scales.x.ticks.font.size = getFontSize(0.6);
        trafficChart.options.scales.y.title.font.size = getFontSize(0.8);
        trafficChart.options.scales.y.ticks.font.size = getFontSize(0.6);
        trafficChart.update();
    
        adjustTableFontSize();
      });
    
      function highlightSelectedMonth(selectedMonth) {
        if (!trafficChart) {
          console.error("❌ `trafficChart` 尚未初始化");
          return;
        }
        const chartElements = trafficChart.getDatasetMeta(0).data;
    
        // 清除所有 `🔴` 標記
        trafficChart.data.labels = trafficChart.data.labels.map(label => label.replace(/🔴 /g, ""));
        
        let selectedIndex = -1;
        
        chartElements.forEach((element, index) => {
          let originalLabel = trafficChart.data.labels[index];
    
          if (originalLabel === selectedMonth) {
            // 標示選中的月份
            trafficChart.data.labels[index] = `🔴 ${selectedMonth}`;
            element.options.backgroundColor = "rgba(255, 99, 132, 0.7)";
            element.options.borderColor = "red";
            element.options.radius = 8;
            element.options.hoverRadius = 10;
            selectedIndex = index;
          } else {
            element.options.backgroundColor = anomalies[index] === -1 ? "red" : "rgba(54, 162, 235, 0.2)";
            element.options.borderColor = anomalies[index] === -1 ? "red" : "blue";
            element.options.radius = anomalies[index] === -1 ? 6 : 3;
            element.options.hoverRadius = anomalies[index] === -1 ? 8 : 5;
          }
        });
    
        trafficChart.options.plugins.tooltip.callbacks.label = function (tooltipItem) {
          if (tooltipItem.dataIndex === selectedIndex) {
            return `✅ 選択済み: ${tooltipItem.raw} 人`;
          }
          return `人流数: ${tooltipItem.raw}`;
        };
    
        trafficChart.update();
      }
    
      // 更新整合後的 updateTrendRanking()，同時以 Google Trend 的數據暫代 Github
      function updateTrendRanking(yearMonth) {
        if (lastSelectedMonth === yearMonth) return;
        lastSelectedMonth = yearMonth;
    
        Promise.all([
          fetch('./data/city_Google_Trends.json').then(response => response.json()),
          fetch('./data/city_GitHub.json').then(response => response.json())
        ])
        .then(([googleData, githubData]) => {
          console.log("🔍 Google Trends 資料:", googleData);
          console.log("🔍 Github 資料:", githubData);
    
          if (!googleData[yearMonth]) {
            console.warn(`⚠️ 沒有找到 ${yearMonth} 的 Google Trend 數據`);
          }
          if (!githubData[yearMonth]) {
            console.warn(`⚠️ 沒有找到 ${yearMonth} 的 Github 數據`);
          }
    
          // 依照 JSON 格式（假設結構與 Google Trend 相同）
          const googleTrends = (googleData[yearMonth] && googleData[yearMonth][city]) || [];
          const githubRanking = (githubData[yearMonth] && githubData[yearMonth][city]) || [];
          
          // 當前月份人流數（依舊從 chart 上取出）
          let index = trafficChart.data.labels.findIndex(label => label.includes(yearMonth));
          let selectedCount = index !== -1 ? trafficChart.data.datasets[0].data[index] : "??";
    
          // 更新標題，顯示所選月份及人流數
          document.getElementById("trendTitle").innerHTML = 
            `ランキング (${yearMonth}) - 人流数 ${selectedCount} 人`;
    
          // 產生排名表格內容，固定 Top 1 至 Top 5
          let html = "";
          for (let i = 0; i < 5; i++) {
            // 若有對應資料則顯示名字，否則顯示「データなし」
            const googleItem = googleTrends[i] ? googleTrends[i].name : "データなし";
            const githubItem = githubRanking[i] ? githubRanking[i].name : "データなし";
    
            html += `
              <tr class="flashing">
                <td>Top${i+1}</td>
                <td>${googleItem}</td>
                <td>${githubItem}</td>
              </tr>
            `;
          }
    
          document.getElementById("trendTable").innerHTML = html;
          highlightSelectedMonth(yearMonth);
        })
        .catch(err => console.error("❌ 載入排名數據失敗: ", err));
      }
    
    });
  </script>

  <a href="./index.html">戻る</a>
</body>
</html>