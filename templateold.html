<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">äººæµæƒ…å ±ã¨è¦³å…‰åæ‰€</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f7f7f7;
            font-size: 1rem;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 2vh;
            font-size: calc(2rem + 0.5vw);
        }

        .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        canvas {
            display: block;
            margin: 0 auto;
            width: 100%;
            max-width: 100%;
            height: auto;
            min-height: 300px;
            max-height: 500px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .attractions {
            margin-top: 5vh;
            padding: 2vh;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2vh;
            font-size: calc(14px + 0.3vw);
        }

        th, td {
            padding: 1.5vh;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f4f4f4;
            font-size: calc(16px + 0.3vw);
        }

        td img {
            width: auto;
            height: 5vh;
        }

        a {
            display: block;
            text-align: center;
            margin-top: 2vh;
            color: #007bff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* âœ… æ–°å¢ï¼šè®“é¸ä¸­æœˆä»½çš„é»é€²è¡Œå‹•ç•«æ•ˆæœ */
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .flashing {
            animation: flash 0.8s ease-in-out 2;
        }
        
    </style>
</head>
<body>
    <div class="content">
        <h1 id="cityTitle"></h1>
        <canvas id="trafficChart"></canvas>

        <div class="attractions">
            <h2 id="trendTitle">Google Trend ã®å‰äº”å</h2>
            <table>
                <thead>
                    <tr>
                        <th>ã‚¢ã‚¤ã‚³ãƒ³</th>
                        <th>è¦³å…‰åæ‰€</th>
                    </tr>
                </thead>
                <tbody id="trendTable">
                    <tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let selectedMonth = null;
        let trafficChart = null;
        let lastSelectedMonth = null;
        let anomalies = []; 

        function getCityFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("city") || "ç¦äº•å¸‚";
        }

        function getFontSize(scale = 1) {
            return Math.max(12, window.innerWidth * 0.02 * scale);
        }

        const city = getCityFromURL();
        document.getElementById("cityTitle").textContent = city + " ã®äººæµæƒ…å ±";
        document.title = city + " ã®äººæµæƒ…å ±ã¨è¦³å…‰åæ‰€";

        document.addEventListener("DOMContentLoaded", function () {
            fetch('./data/city_traffic.json')
                .then(response => response.json())
                .then(data => {
                    if (!data[city]) {
                        console.error(`âŒ æ‰¾ä¸åˆ° ${city} çš„æ•¸æ“š`);
                        return;
                    }

                    const cityData = data[city];
                    const months = cityData.month;
                    const counts = cityData.count;
                    anomalies = cityData.anomaly; // âœ… å„²å­˜ anomaliesï¼Œç¢ºä¿ highlightSelectedMonth() å¯ä»¥ä½¿ç”¨

                    const ctx = document.getElementById('trafficChart').getContext('2d');

                    function createChart() {
                        return new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: months,
                                datasets: [{
                                    label: 'äººæµæ•¸',
                                    data: counts,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    fill: true,
                                    borderWidth: 2,
                                    tension: 0.4,
                                    pointBackgroundColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                                    pointBorderColor: anomalies.map(a => a === -1 ? 'red' : 'blue'),
                                    pointRadius: anomalies.map(a => a === -1 ? 6 : 3),
                                    pointHoverRadius: anomalies.map(a => a === -1 ? 8 : 5)
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: city + ' äººæµæ•¸è¶¨å‹¢åœ–',
                                        font: { size: getFontSize(1.2) } // ğŸ”¹ æ¨™é¡Œå­—é«”è¼ƒå¤§
                                    },
                                    tooltip: {
                                        titleFont: { size: getFontSize(0.5) }, // ğŸ”¹ Tooltip æ¨™é¡Œ
                                        bodyFont: { size: getFontSize(0.5) }  // ğŸ”¹ Tooltip å…§å®¹
                                    }
                                },
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'æœˆä»½',
                                            font: { size: getFontSize(0.6) } // ğŸ”¹ X è»¸æ¨™é¡Œå­—é«”
                                        },
                                        ticks: {
                                            font: { size: getFontSize(0.5) } // ğŸ”¹ X è»¸æ¨™ç±¤å­—é«”
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'äººæµæ•¸',
                                            font: { size: getFontSize(0.6) }
                                        },
                                        ticks: {
                                            font: { size: getFontSize(0.5) }
                                        }
                                    }
                                },
                                onClick: (event, activeElements) => {
                                    if (activeElements.length > 0) {
                                        const index = activeElements[0].index;
                                        let clickedMonth = trafficChart.data.labels[index].replace(/ğŸ”´ /g, ""); 
                                        
                                        console.log("ğŸŸ¢ é¸ä¸­çš„æœˆä»½:", clickedMonth); // âœ… ç¢ºä¿æœ‰æŠ“åˆ°é»æ“Šçš„æœˆä»½
                                        
                                        // âœ… æ›´æ–° Google Trend è¡¨æ ¼
                                        updateTrendRanking(clickedMonth);
                    
                                        // âœ… æ¨™è¨˜é»æ“Šçš„æœˆä»½
                                        highlightSelectedMonth(clickedMonth);
                                    }
                                }
                            }
                        });
                    }
                    

                    trafficChart = createChart();
                })
                .catch(err => console.error("æ•¸æ“šåŠ è¼‰å¤±æ•—: ", err));
                
                function adjustTableFontSize() {
                    document.querySelector("h2#trendTitle").style.fontSize = getFontSize(0.7) + "px";
                    document.querySelectorAll("th").forEach(th => th.style.fontSize = getFontSize(0.7) + "px");
                    document.querySelectorAll("td").forEach(td => td.style.fontSize = getFontSize(0.6) + "px");
                }
    
                adjustTableFontSize();
                window.addEventListener("resize", function () {
                    trafficChart.options.plugins.title.font.size = getFontSize(0.8);
                    trafficChart.options.scales.x.title.font.size = getFontSize(0.6);
                    trafficChart.options.scales.x.ticks.font.size = getFontSize(0.6);
                    trafficChart.options.scales.y.title.font.size = getFontSize(0.8);
                    trafficChart.options.scales.y.ticks.font.size = getFontSize(0.6);
                    trafficChart.update();
    
                    adjustTableFontSize();
                });
            
            function highlightSelectedMonth(selectedMonth) {
                if (!trafficChart) {
                    console.error("âŒ `trafficChart` å°šæœªåˆå§‹åŒ–");
                    return;
                }
                const chartElements = trafficChart.getDatasetMeta(0).data;
            
                // âœ… **æ¸…é™¤æ‰€æœ‰ `ğŸ”´`ï¼Œç¢ºä¿æ¯æ¬¡é»æ“Šæ™‚ `ğŸ”´` åªå‡ºç¾åœ¨ç•¶å‰é¸ä¸­çš„æœˆä»½**
                trafficChart.data.labels = trafficChart.data.labels.map(label => label.replace(/ğŸ”´ /g, ""));
                
                let selectedIndex = -1;
                
                chartElements.forEach((element, index) => {
                    let originalLabel = trafficChart.data.labels[index];
            
                    if (originalLabel === selectedMonth) {
                        // âœ… **ç¢ºä¿ç•¶å‰é¸æ“‡çš„æœˆä»½è¢«æ¨™ç¤º**
                        trafficChart.data.labels[index] = `ğŸ”´ ${selectedMonth}`;
                        element.options.backgroundColor = "rgba(255, 99, 132, 0.7)"; // **ç´…è‰²èƒŒæ™¯**
                        element.options.borderColor = "red";
                        element.options.radius = 8; // **æ”¾å¤§é¸ä¸­çš„é»**
                        element.options.hoverRadius = 10; // **æ»‘é¼ æ‡¸åœæ™‚æ›´å¤§**
                        selectedIndex = index; // ç´€éŒ„é¸ä¸­çš„ index
                    } else {
                        // âœ… **ç¢ºä¿æ‰€æœ‰å…¶ä»–é»å›å¾©æ­£å¸¸ç‹€æ…‹**
                        element.options.backgroundColor = anomalies[index] === -1 ? "red" : "rgba(54, 162, 235, 0.2)"; 
                        element.options.borderColor = anomalies[index] === -1 ? "red" : "blue";
                        element.options.radius = anomalies[index] === -1 ? 6 : 3; 
                        element.options.hoverRadius = anomalies[index] === -1 ? 8 : 5;
                    }
                });
            
                // âœ… **å‹•æ…‹æ›´æ–° Tooltipï¼Œé¸ä¸­çš„æœˆä»½é¡¯ç¤ºã€Œâœ… é¸æŠæ¸ˆã¿ã€**
                trafficChart.options.plugins.tooltip.callbacks.label = function (tooltipItem) {
                    if (tooltipItem.dataIndex === selectedIndex) {
                        return `âœ… é¸æŠæ¸ˆã¿: ${tooltipItem.raw} äºº`;
                    }
                    return `äººæµæ•°: ${tooltipItem.raw}`;
                };
            
                // âœ… **å¼·åˆ¶æ›´æ–°åœ–è¡¨**
                trafficChart.update();
            }
        
            function updateTrendRanking(yearMonth) {
                if (lastSelectedMonth === yearMonth) return;
                lastSelectedMonth = yearMonth;
            
                fetch('./data/city_Google_Trends.json')
                    .then(response => response.json())
                    .then(cityTrends => {
                        console.log("ğŸ” è¼‰å…¥çš„ Google Trends æ•¸æ“š:", cityTrends);
                        
                        if (!cityTrends[yearMonth]) {
                            console.warn(`âš ï¸ æ²’æœ‰æ‰¾åˆ° ${yearMonth} çš„ Google Trend æ•¸æ“š`);
                            document.getElementById("trendTable").innerHTML = `<tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
                            return;
                        }
            
                        const trends = cityTrends[yearMonth][city] || [];

                        console.log(`âœ… ${yearMonth} çš„ ${city} Google Trend`, trends); // âœ… ç¢ºä¿æ•¸æ“šå­˜åœ¨

                        // âœ… **å³æ™‚å–å¾—é¸ä¸­æœˆä»½äººæµæ•¸**
                        let index = trafficChart.data.labels.findIndex(label => label.includes(yearMonth));
                        let selectedCount = index !== -1 ? trafficChart.data.datasets[0].data[index] : "??";
            
                        // âœ… **æ›´æ–°æ¨™é¡Œï¼Œé¡¯ç¤ºäººæ•¸**
                        document.getElementById("trendTitle").innerHTML = 
                            `Google Trend ã®å‰äº”å <span style="color:red;">(${yearMonth})</span> - äººæµæ•° ${selectedCount} äºº`;
            
                        let html = trends.length > 0 ? trends.slice(0, 5).map(trend => `
                            <tr class="flashing">
                                <td><img src="./data/Google-Trend-Logo.png" alt="Google Trend Logo"></td>
                                <td>${trend.name}</td>
                            </tr>
                        `).join("") : `<tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
            
                        document.getElementById("trendTable").innerHTML = html;
            
                        highlightSelectedMonth(yearMonth);
                    })
                    .catch(err => console.error("âŒ è¼‰å…¥ Google Trends å¤±æ•—: ", err));
            }
                                
        });
    </script>

    <a href="./index.html">æˆ»ã‚‹</a>
</body>
</html>
